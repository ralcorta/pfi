#!/usr/bin/env python3
"""
Script para verificar detecciones de malware en DynamoDB
"""
import os
import sys
from app.sensor.src.utils.dynamo_client import DynamoClient

def check_malware_detections():
    """Verifica y muestra las detecciones de malware en DynamoDB"""
    
    # Configurar DynamoDB local
    os.environ['AWS_ENDPOINT_URL'] = 'http://localhost:8000'
    os.environ['AWS_ACCESS_KEY_ID'] = 'dummy'
    os.environ['AWS_SECRET_ACCESS_KEY'] = 'dummy'
    os.environ['AWS_DEFAULT_REGION'] = 'us-east-1'
    
    try:
        client = DynamoClient('demo-pcap-control')
        
        # Buscar todas las detecciones de malware
        detections = client.table.scan(
            FilterExpression='begins_with(id, :prefix)',
            ExpressionAttributeValues={':prefix': 'malware_'}
        )
        
        items = detections.get('Items', [])
        print(f'üîç Detecciones encontradas: {len(items)}')
        
        if items:
            for item in items:
                malware_type = item.get('malware_type', 'unknown')
                source_ip = item.get('source_ip', 'unknown')
                confidence = item.get('confidence', 0)
                packet_count = item.get('packet_count', 0)
                print(f'  - {malware_type} desde {source_ip} (confianza: {confidence:.2f}, paquetes: {packet_count})')
        else:
            print('  - No se encontraron detecciones de malware')
            
    except Exception as e:
        print(f'‚ùå Error verificando detecciones: {e}')
        sys.exit(1)

if __name__ == "__main__":
    check_malware_detections()
